<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://ironhacks.github.io/docs/3-Cloud-Api/usage/">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Usage - IronHacks Platform</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../assets/css/custom.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Usage";
    var mkdocs_page_input_path = "3-Cloud-Api/usage.md";
    var mkdocs_page_url = "/docs/3-Cloud-Api/usage/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> IronHacks Platform</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">IronHacks</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">1 Platform Documentation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../1-Platform-Documentation/">Platform Documentation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../1-Platform-Documentation/admin/">Admin</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../1-Platform-Documentation/hacks/">Hacks</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../1-Platform-Documentation/metrics/">Platform Metrics</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">2 Developer Documentation</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../2-Developer-Documentation/install/">Install</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../2-Developer-Documentation/overview/">Overview</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../2-Developer-Documentation/references/">References</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../2-Developer-Documentation/services/">Preparation</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../2-Developer-Documentation/usage/">Usage</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">3 Cloud Api</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../requirements/">Requirements</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../setup/">Setup</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Usage</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#creategithubrepo">createGithubRepo</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#committogithub">commitToGitHub</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#project-editor">Project Editor</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#account-management">Account Management</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#utilities">Utilities</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#amazon-ses-forum">Amazon SES &amp; Forum</a>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">IronHacks Platform</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>3 Cloud Api &raquo;</li>
        
      
    
    <li>Usage</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/ironhacks/docs/blob/master/docs/3-Cloud-Api/usage.md"
          class="icon icon-github"> Edit on Github</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="github-api">GitHub API</h2>
<ul>
<li><a href="#committogithub"><strong>commitToGitHub</strong></a></li>
<li><a href="#creategithubrepo"><strong>createGitHubRepo</strong></a></li>
</ul>
<p>The flow here is quite simple, we a user creates a project, create that project in two different places: The user&rsquo;s firebase storage folder and the GitHub organization specified on the initialization section.</p>
<p>The user will query the Firebase storage when using the platform, so we always store the latest version of the user project there. However, for the judger to work, we ask the user to &ldquo;push&rdquo; the version that is going to be evaluated. This &ldquo;push&rdquo; actually pushes the files to the GitHub repo.</p>
<p>So the judger can retrieve them from GitHub.</p>
<p>Keep in mind that this is transparent for the user.</p>
<p><strong>Github Configuration</strong></p>
<pre><code class="language-js">const github = require(&quot;octonode&quot;);
const githubPersonalAccessToken = process.env.GITHUB_ACCESS_TOKEN;
const client = github.client(githubPersonalAccessToken);
const ghme = client.me();
const ghorg = client.org(&quot;UNALIronHacks&quot;);

module.exports = {
  github: github,
  client: client,
  me: ghme,
  org: ghorg,
};
</code></pre>
<p>Let&rsquo;s start by the GitHub repository creation:</p>
<h3 id="creategithubrepo">createGithubRepo</h3>
<p>Parameters:</p>
<pre><code class="language-javascript">const newRepoConfig = {
  name: projectName,
  description: 'UNAL-ironhacks-spring-2019',
  private: true,
  auto_init: true,
}
</code></pre>
<pre><code class="language-javascript">exports.createGitHubRepo = functions.https.onCall(async (data, context) =&gt; {
  try {
    const result = await ghorg.repoAsync(data);
    return result;
  } catch(err) {
    return {message: 'Error', error: err, status: 500};
  }  
})
</code></pre>
<p>This function is really simple, is just a call to the Octonode library (check <a href="https://github.com/pksunkara/octonode">their docs</a>) to create a new empty repo.</p>
<p>Please refer to the <a href="https://github.com/pksunkara/octonode">Octonode docs</a> to understand how <code>ghrepo.contentsAsync</code>, <code>ghrepo.updateContentsAsync</code> and <code>ghrepo.createContentsAsync</code> works.</p>
<h3 id="committogithub">commitToGitHub</h3>
<p>Main function that submits the committed files to the GitHub API</p>
<pre><code class="language-js">const commitToGitHub = functions.https.onCall(async (data, context) =&gt; {
  const ghrepo = gh.client.repo(&quot;UNALIronHacks/&quot; + data.name);

  const { commitMessage, files } = data;
  const result = await commitChanges(commitMessage, files, ghrepo);
  return result;
});
</code></pre>
<h3 id="project-editor">Project Editor</h3>
<ul>
<li><strong>previewWebServer</strong></li>
</ul>
<h3 id="account-management">Account Management</h3>
<ul>
<li><strong>registerUser</strong></li>
</ul>
<h3 id="utilities">Utilities</h3>
<ul>
<li><strong>getPhaseResults</strong></li>
<li><strong>getTaskDoc</strong></li>
<li><strong>saveLikedCompetitors</strong></li>
<li><strong>saveStat</strong></li>
</ul>
<h3 id="amazon-ses-forum">Amazon SES &amp; Forum</h3>
<ul>
<li><strong>newThreadEmailNotification</strong></li>
</ul>
<pre><code class="language-javascript">admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: functions.config().database.url
});

</code></pre>
<p>Besides import the libraries required (we will address them on the fuctions in where they are used, if needed), there are some importants things you should check:</p>
<pre><code class="language-javascript">const newThreadEmailNotification = require('./amazonSESfunctions');
</code></pre>
<p>The email functionality is in it own js file, and we import them here just to export it amogn the bundle. (We will address it at the end)</p>
<pre><code class="language-javascript">const serviceAccount = require('./service-account.json');
</code></pre>
<p>Here we import our Firebase project keys from a local file, remember, you <em><strong>should not</strong></em> upload this file to the repository.</p>
<p>And just after that, we initialized the Firebase admin library:</p>
<pre><code class="language-javascript">admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  databaseURL: functions.config().database.url
});
</code></pre>
<p>Notice how we access to the env variables in order to get the database URL.</p>
<p>Here we catch the personal key from the env variables, then we use it to create the instance of github octonode.</p>
<pre><code class="language-javascript">const githubPersonalAccessToken = functions.config().githubapi.personalkey;
</code></pre>
<p>And then we create the &ldquo;user&rdquo; object and also select the organization on which we will create the repositories of the projects. Remember that this have to be a PRO user and a PRO organization in order to be able to create private repos.</p>
<p>(Please check the <a href="https://github.com/pksunkara/octonode">Octonode docs</a> if you feel rusty here); in this case the organization is called &ldquo;UNALIronhacks&rdquo;, this was the one we used back then, you should put your own one there.</p>
<pre><code class="language-javascript">const ghme = client.me();
const ghorg = client.org('UNALIronHacks');
</code></pre>
<h2 id="registration-process">Registration Process</h2>
<p>The first group of functions is related with the registration process of an user and is composed by two functions:</p>
<pre><code class="language-javascript">exports.registerUser = functions.https.onCall((data, context) =&gt; {...})
const getNewParticipantForumId = (hackId, userId) =&gt; {...}
</code></pre>
<p>As you can see, only one function is exported, <code>registerUser</code>.</p>
<p><code>getPartipantForumId</code> is and utility used by the first one.</p>
<hr />
<h3 id="registeruserhackid">registerUser(hackID)</h3>
<p>On <code>./functions/index.js</code></p>
<p>Parameters:</p>
<pre><code class="language-json">{ &quot;hackId&quot;: &quot;hackId&quot;}
</code></pre>
<p>hackId is the id from a hack documment on the database.</p>
<pre><code class="language-javascript">exports.registerUser = functions.https.onCall((data, context) =&gt; {
  return db.collection(&quot;adminHackData&quot;)
  .doc(data.hackId)
  .set({
    registeredUsers: admin.firestore.FieldValue.arrayUnion(context.auth.uid)
  }, {merge: true})
  .then((result) =&gt; {
    return getNewParticipantForumId(data.hackId, context.auth.uid)
    .then((forum) =&gt; {
      return db.collection('users')
      .doc(context.auth.uid)
      .set({
        hacks: admin.firestore.FieldValue.arrayUnion(data.hackId),
        forums: forum,
      }, {merge: true})
      .then((result) =&gt; {
        return {message: 'success', status: 200};
      })
      .catch(error =&gt; {
        return {message: error, status: 500};
      })
    })
    .catch(error =&gt; {
      return {message: error, status: 500};
    })
  })
  .catch(error =&gt; {
      return {message: error, status: 500};
  })
});
</code></pre>
<p>This function will retrieve the hack data corresponding with the hackId sended as parameter from the adminHackData colletion, it will add the userID to the registeredUsers array and update the hack document. Then, it will ask for the forumID the user was register on and will update the user&rsquo;s documment, adding the hackID and the forumID to it.</p>
<hr />
<h3 id="getnewparticipantforumidhackid-userid">getNewParticipantForumId(hackId, userId)</h3>
<p>On <code>./functions/index.js</code></p>
<p>Parameters:</p>
<pre><code>hackID : String
userID : String
</code></pre>
<pre><code class="language-javascript">const getNewParticipantForumId = (hackId, userId) =&gt; {
  return db.collection(&quot;forums&quot;)
  .where('hack', '==', hackId)
  .get()
  .then((querySnapshot) =&gt; {
    let selectedForum;
    let forumParticipants = -1;
    querySnapshot.forEach((doc) =&gt; {
      const legth = Object.keys(doc.data().participants)
      if(forumParticipants === -1){
        selectedForum = doc;
        forumParticipants = Object.keys(doc.data().participants);
      }else if(Object.keys(doc.data().participants).length &lt; forumParticipants.length){
        selectedForum = doc;
        forumParticipants = Object.keys(doc.data().participants);
      }
    });
    return db.collection('forums').doc(selectedForum.id)
    .set({participants: {[userId]: `Hacker ${forumParticipants.length + 1}`}}, {merge: true})
    .then(() =&gt; {
      const forum = {};
      forum[hackId] = {id: selectedForum.id};
      return forum;
    })
    .catch(error =&gt; {
      return {message: error, status: 500};
    })
  }).catch(error =&gt; {
      return {message: error, status: 500};
  })
}
</code></pre>
<p>This function will search into the formus of a given hack (hackID) the one which have the less participants registered on, then it will register the new participant (userID) on it and will return the forum id.</p>
<h2 id="project-editor_1">Project Editor</h2>
<p>Now we are going to describe the function related with the project editor:</p>
<pre><code class="language-javascript">exports.previewWebServer = functions.https.onRequest((req, res) =&gt; {...})
</code></pre>
<p>Although you could say that the Github API are also related, for the sake of consistency, we are going to separate the thirdh party ones from this group.</p>
<p>One of the biggest needs to the platform is to be able to preview the mockup that is being developed by a participant. Basically, to have a web server. However, What the platform tryes to do here is to mimik the behaviour of a web server, using only cloud functions. Even if a first glance it looks like an over engineered solution, the idea here is to have the less amount of compoenents posible and create a platform easy to use.</p>
<h3 id="preview-aka-web-server">Preview (AKA Web Server)</h3>
<p>The preview system relies on to key components, the <code>previewWebServer</code> function and the rewrite is defined on the config file:</p>
<p>On <code>./firebase.json</code></p>
<pre><code class="language-json">...
  &quot;rewrites&quot;: [
    {
      &quot;source&quot;: &quot;/preview/**&quot;,
      &quot;function&quot;: &quot;previewWebServer&quot;
    },
    {
      &quot;source&quot;: &quot;**&quot;,
      &quot;destination&quot;: &quot;/index.html&quot;
    }
  ]
},
...
</code></pre>
<p>First, let&rsquo;s look the config file: We are redirecting everything that go to the preview url to call the previewWebServer function, this allow the function to be triggered whenever a file for a given is requested. Let&rsquo;s check the function itself:</p>
<pre><code class="language-javascript">exports.previewWebServer = functions.https.onRequest((req, res) =&gt; {
  const filePathStorage = req.originalUrl.replace('/preview', '');
  const fileName = path.basename(filePathStorage);

  const tempPath = path.join(os.tmpdir(), `${fileName}`);
  return storage
  .bucket(functions.config().database.bucket)
  .file(filePathStorage)
  .download({
    destination: tempPath,
  }).then(() =&gt; {
    res.sendFile(tempPath, (err) =&gt; {
      if (err) {
        return res.end();
      }else{
        return res.end();
      }
    });
  }).catch((error) =&gt; {
    console.error(error.message);
    if(error.message === 'Not Found') {
      console.error('File not found', filePathStorage);
      return res.status(404).send('File not found on storage');
    }else{
      return res.status(500).send(error.message);
    }
  })
});
</code></pre>
<p>We call this function directly from the browser (since the idea is to replicate a web server), and the structure of the URL is the following:</p>
<pre><code class="language-javascript">const projectURL = `${Constants.cloudFunctionsProdEndPoint}/previewWebServer/${this.state.user.uid}/${this.state.projectName}/index.html`;
</code></pre>
<p>The Constants.cloudFunctionsProdEnd is the endpoint of your firebase cloud functions project.</p>
<p>This function will retrieve the resource requested on the path, in this case, we allways start by de index.html. Once the index.html is loaded by the browser, it will call again the same function in order to load additional assets, for example, a javascript file.</p>
<p>Since we rewrite de function, everytime the browser request other file, like <code>js/main.js</code> it will be redirected to the previewWebServer function, and it will retrieve the file.</p>
<p>Keep in mind that this function retrieve the files from the Firebase storage service.</p>
<h1 id="experiment-related-functions">Experiment related functions</h1>
<p>Since the main idea of the platform is to create specific conditions related with the experiment that is being done, the platform exposes 4 particular functions that will help you to do that:</p>
<pre><code class="language-javascript">exports.getTaskDoc = functions.https.onCall((data, context) =&gt; {...}
exports.saveStat = functions.https.onCall((data, context) =&gt; {...}
exports.getPhaseResults = functions.https.onCall((data, context) =&gt; {...}
exports.saveLikedCompetitors = functions.https.onCall((data, context) =&gt; {...}
</code></pre>
<p>Let&rsquo;s start by the most basic:</p>
<h3 id="gettaskdoc">getTaskDoc</h3>
<p>This function return the Task document, this is the documment that contains the challenge or problem the participants of a hack will face. Keep in mind that the document will only be served if the publish date already pass. Also keep in mind that the content of the file is encode in base64.</p>
<pre><code class="language-javascript">exports.getTaskDoc = functions.https.onCall((data, context) =&gt; {
  const currentDate = new Date();
  return db.collection(&quot;adminHackData&quot;)
  .doc(data.hackId)
  .get()
  .then((doc) =&gt; {
    const seconds = doc.data().task.releaseDate._seconds
    const nanoseconds = doc.data().task.releaseDate._nanoseconds
    const releaseDate = new admin.firestore.Timestamp(seconds, nanoseconds).toDate();
    if(releaseDate &lt; currentDate){
      return {task: doc.data().task.doc};
    }else {
      return {error: 'To early', status: 500};
    }
  })
  .catch(error =&gt; {
    console.error(error);
    return {message: error, status: 500};
  })
});
</code></pre>
<h3 id="savestat">saveStat</h3>
<p>The platform allows you to collect stats, you can pretty much collect every single interaction and saving it on the database by calling this function:</p>
<pre><code class="language-javascript">exports.saveStat = functions.https.onCall((data, context) =&gt; {
  const currentDate = new Date();
  data.date = currentDate;
  return db.collection(&quot;stats&quot;)
  .add(data)
  .then(function(docRef) {
    return {&quot;result&quot;: &quot;job done&quot;, &quot;status&quot;: 204};
  })
  .catch(function(error) {
    console.error(&quot;Error adding document: &quot;, error);
    return {&quot;error&quot;: error, &quot;status&quot;: 500};
  });
});
</code></pre>
<p>Basically, you call it from the client, and sent an object as parameter, this object should keep the following structure:</p>
<pre><code class="language-javascript">stat = {
  event: 'the name of the stat',
  metadata: {...},
  userId: 'a user id',
}
</code></pre>
<p>On the metadata object you can store pretty much anything, is just complementary information to the stat itself.</p>
<h1 id="amazon-ses">Amazon SES</h1>
<p>The integration with Amazon SES is pretty simple, we set a trigger on the comments collection that is activated when a new documment is done on that collection:</p>
<pre><code class="language-javascript">exports.newThreadEmailNotification = functions.firestore
.document('comments/{commentId}')
.onCreate(newThreadEmailNotification);
</code></pre>
<p>The function called on the trigger is <code>newThreadEmailNotification</code></p>
<p><em>On: ./funtions/amazonSESFunctions</em></p>
<pre><code class="language-javascript">module.exports = newThreadEmailNotification = (doc, context) =&gt; {
  const commentData = doc.data();
  let subject = 'The Ironhacks Platform - There is a new comment on a topic you commented! check it out!'
  commentData.id = doc.id;

  if (commentData.forumId) {
    subject = 'The Ironhacks Platform - There is a new topic on the forum! check it out!'
  }

  const params = {
    Destination: {
      ToAddresses: [
        'example@example.com',
      ],
    },
    Message: {
      Body: {
        Html: {
          Charset: 'UTF-8',
          Data: forumActivityTemplate
          .replace('[topic-title]', 'a title')
          .replace('[comment-body]', commentData.body)
          .replace('[thread-id]', commentData.threadID),
        },
        Text: {
          Charset: 'UTF-8',
          Data: `
           The Ironhacks &lt;Platform&gt;&lt;/Platform&gt;

           Hey! there is a new [item-type] posted on the forum! check it out!

           ${commentData.title}
           ${commentData.body}

           https://ironhacks.com/forum/thread/${commentData.id}


           This is an automatic email, do not reply.
           `,
        },
      },
      Subject: {
        Charset: 'UTF-8',
        Data: subject,
      },
    },
    Source: 'RCODI &lt;researchopendigitalinnovation@gmail.com&gt;',
    ReplyToAddresses: [
      'researchopendigitalinnovation@gmail.com',
    ],
  };

  const sendPromise = new AWS.SES({
    apiVersion: '2010-12-01',
  }).sendEmail(params).promise();

  return sendPromise.then((data) =&gt; {
    console.log(`Forum activity email sent ${data.MessageId}`);
    return true;
  }).catch((error) =&gt; {
    console.error('Forum activity email not sent', error, error.stack);
  });
};
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../setup/" class="btn btn-neutral" title="Setup"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>RCODI 2021</p>
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../setup/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
